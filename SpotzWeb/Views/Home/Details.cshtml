@using Microsoft.AspNet.Identity
@model SpotzWeb.Models.SpotzDetailViewModel

@{
    ViewBag.Title = "Details";
}

    


<h2>@Model.Spotz.Title</h2>

<div class="row">
    <div class="col-md-4">
        
        <img src="@Model.GetLatestImage()" id="spotz-image" class="img-responsive" alt="@Model.Spotz.Title"/>

        <form action="/api/fileupload/@Model.Spotz.SpotzId"
              class="dropzone"
              id="dropzoneForm">
            <div class="col-md-6">
                <input type="text" name="title" placeholder="Title" class="form-control"/>
            </div>
            <div class="col-md-6">
                <input type="submit" value="Add Photo(s)" id="addImageBtn" class="btn btn-info"/>
            </div>
            
           
        </form>
    </div>
    
    <div class="col-md-8">
        <div class="col-md-12">KART</div>
        <div class="col-md-8">TAGS</div>
        <div class="col-md-4">
            <h3>@Model.Spotz.User.UserName</h3>
            <img src="@Model.Spotz.User.GravatarUrl" class="img-responsive" alt="@Model.Spotz.User.UserName" />
        </div>
    </div>
    <div class="col-md-12 image-row">
        @foreach (var image in Model.Spotz.Images)
        {
            <a data-fancybox="gallery" href="@image.ImageUrl"><img src="@image.ImageUrl/?thumb=100"></a>
        }
    </div>

</div>
<div class="row">
    <div class="col-md-12">
        @Model.Spotz.Description
    </div>

</div>
<h3>Comments:</h3>
<button id="addCommentBtn" class="btn btn-default">Add Comment</button>
<div id="addComment" class="">
    <textarea class="text-area form-control" id="addCommentText" type="text"></textarea>

</div>
<div id="new-comment-wrapper"></div>
<div id="comment-wrapper">
    @foreach (var item in @Model.Spotz.Comments)
    {
        <div class="row comment-section">

            <div class="col-md-2">
                <h3>@item.User.UserName</h3>
                <img src="@item.User.GravatarUrl" class="img-responsive" alt="@item.User.UserName" />
            </div>
            <div class="col-md-10">
                @item.Text
            </div>

        </div>
    }
</div>

<p>
    @Html.ActionLink("Edit", "Edit", new { id = Model.Spotz.SpotzId }) |
    @Html.ActionLink("Back to List", "Index")
</p>

@Styles.Render("/Scripts/dropzone/dropzone.min.css")
@Styles.Render("/Scripts/fancybox3/jquery.fancybox.min.css")

@section scripts {
<script src="/Scripts/dropzone/dropzone.min.js" type="text/javascript"></script>
<script src="/Scripts/fancybox3/jquery.fancybox.min.js" type="text/javascript"></script>
    <Script>
        
        //File Upload response from the server
        Dropzone.options.dropzoneForm = {
            autoProcessQueue: false,
            uploadMultiple: false,
            maxFiles: 1,
            addRemoveLinks: true,
            parallelUploads: 100,

            init: function () {

                var myDropZone = this;

                $('#dropzoneForm').on('submit', uploadFile);

                function uploadFile(e) {

                    e.preventDefault();
                    e.stopPropagation();
                    myDropZone.processQueue();
                }

                this.on("complete", function (data) {
                    if (data.response !== "error") {
                        $('#spotz-image').attr(src, data.imgurl);
                    }
                    //var res = eval('(' + data.xhr.responseText + ')');
                    var res = JSON.parse(data.xhr.responseText);
                });
            }
        };

        var addCommentButton = $('#addCommentBtn');
        var currentUser = '@User.Identity.GetUserId()';
        var spotzId = '@Model.Spotz.SpotzId';
        var commentField = document.getElementById('addCommentText');
        var url = '/Home/AddComment/' + spotzId;

        addCommentButton.click(function () {

            $.post('/api/SpotzApi/AddComment/',
                {
                    Id: spotzId,
                    UserId: currentUser,
                    Comment: commentField.value
                })
                .done(function (data) {
                    console.log('Succcess!');
                    commentField.value = 'Takk for kommentaren!';
                    $('#new-comment-wrapper').html(
                        '<div class=\'row comment-section\'>' +
                        '<div class="col-md-2">' +
                        data.user +
                        "<img src='" +
                        data.gravatarurl +
                        "' class='img-responsive' />" +
                        "</div><div class='col-md-10'>" +
                        data.comment +
                        "</div></div>");

                }).fail(function (err) {
                    console.error(err);
                });



        });


    </Script>
}



